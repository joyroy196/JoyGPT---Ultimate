<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JoyGPT</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            50: '#f0f4f9',
                            100: '#e1e7ef',
                            200: '#c3cfde',
                            800: '#1e1f20',
                            900: '#131314',
                            accent: '#4285f4'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Markdown Styles */
        .prose pre { background-color: #1e293b; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .prose code { background-color: rgba(0,0,0,0.1); padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875em; }
        .dark .prose code { background-color: rgba(255,255,255,0.1); color: #e2e8f0; }
        .prose p { margin-bottom: 0.75rem; line-height: 1.6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.75rem; }
        
        /* Mobile Layout Fixes */
        body, html { height: 100%; overflow: hidden; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Loading Animation */
        .typing-cursor::after {
            content: 'â–‹';
            animation: blink 1s step-start infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-white dark:bg-gemini-900 text-slate-800 dark:text-slate-200 font-sans transition-colors duration-200">

    <div id="app-loader" class="fixed inset-0 z-50 flex items-center justify-center bg-white dark:bg-gemini-900">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-slate-500 font-medium">Loading JoyGPT...</p>
        </div>
    </div>

    <div id="app" class="flex h-[100dvh] w-full hidden opacity-0 transition-opacity duration-300">
        
        <aside id="sidebar" class="absolute md:relative z-40 w-72 h-full bg-gemini-50 dark:bg-gemini-800 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col border-r border-slate-200 dark:border-slate-700 shadow-xl md:shadow-none">
            
            <div class="p-4 flex items-center justify-between">
                <button onclick="createNewChat()" class="flex-1 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 text-sm font-medium py-2.5 px-4 rounded-full flex items-center gap-2 transition-colors">
                    <i class="fa-solid fa-plus text-slate-500 dark:text-slate-400"></i>
                    <span>New Chat</span>
                </button>
                <button onclick="toggleSidebar()" class="md:hidden ml-3 text-slate-500">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-history-list">
                </div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-700 space-y-2">
                <button onclick="openSettings()" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-lg transition-colors">
                    <i class="fa-solid fa-gear"></i> Settings & Models
                </button>
                <div class="flex items-center justify-between px-3 pt-2">
                    <span class="text-xs text-slate-400">Dark Mode</span>
                    <button onclick="toggleTheme()" class="text-slate-500 hover:text-blue-500 transition-colors">
                        <i id="theme-icon" class="fa-solid fa-moon"></i>
                    </button>
                </div>
            </div>
        </aside>

        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass"></div>

        <main class="flex-1 flex flex-col relative w-full h-full bg-white dark:bg-gemini-900">
            
            <div class="md:hidden flex items-center justify-between p-4 border-b border-slate-100 dark:border-slate-800">
                <button onclick="toggleSidebar()" class="text-slate-500 dark:text-slate-400">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>
                <span class="font-semibold text-slate-700 dark:text-slate-200">JoyGPT</span>
                <div class="w-6"></div> </div>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth pb-32">
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center opacity-80 mt-[-50px]">
                    <div class="w-16 h-16 bg-gradient-to-tr from-blue-400 to-red-400 rounded-2xl mb-6 shadow-lg animate-pulse"></div>
                    <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-500 mb-2">Hi Joy</h1>
                    <p class="text-slate-500 dark:text-slate-400 max-w-md">How can i help you Today?</p>
                </div>
            </div>

            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-white via-white to-transparent dark:from-gemini-900 dark:via-gemini-900 pt-10 pb-4 px-4 z-20">
                <div class="max-w-3xl mx-auto relative">
                    
                    <div id="image-preview-container" class="hidden absolute -top-16 left-0 bg-white dark:bg-slate-800 p-2 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 flex items-start gap-2">
                        <img id="image-preview" src="" alt="Preview" class="h-12 w-auto rounded object-cover">
                        <button onclick="clearImage()" class="text-red-500 hover:text-red-700 bg-white dark:bg-slate-700 rounded-full w-5 h-5 flex items-center justify-center text-xs shadow">
                            <i class="fa-solid fa-times"></i>
                        </button>
                    </div>

                    <div class="flex items-end gap-2 bg-slate-100 dark:bg-gemini-800 border border-slate-200 dark:border-slate-700 rounded-3xl p-2 pl-4 shadow-sm focus-within:ring-2 focus-within:ring-blue-500/50 transition-all">
                        
                        <button onclick="document.getElementById('image-upload').click()" class="p-2 text-slate-500 hover:text-blue-500 dark:hover:text-blue-400 transition-colors mb-0.5" title="Upload Image">
                            <i class="fa-solid fa-paperclip text-lg"></i>
                        </button>
                        <input type="file" id="image-upload" accept="image/png, image/jpeg, image/webp" class="hidden" onchange="handleImageUpload(event)">

                        <textarea id="user-input" rows="1" class="w-full bg-transparent border-none focus:ring-0 resize-none py-3 max-h-32 text-slate-800 dark:text-slate-100 placeholder-slate-500" placeholder="Ask anything..."></textarea>

                        <button onclick="sendMessage()" id="send-btn" class="p-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-full transition-all disabled:opacity-50 disabled:cursor-not-allowed mb-0.5">
                            <i class="fa-solid fa-paper-plane text-sm"></i>
                        </button>
                    </div>
                    <p class="text-center text-xs text-slate-400 mt-2">Gemini can make mistakes. Check important info.</p>
                </div>
            </div>

        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm">
        <div class="bg-white dark:bg-gemini-800 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden m-4 flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
                <h2 class="text-lg font-bold">Settings</h2>
                <button onclick="closeSettings()" class="text-slate-500 hover:text-slate-800 dark:hover:text-slate-200"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            
            <div class="p-6 space-y-6 overflow-y-auto">
                <div>
                    <label class="block text-sm font-medium mb-1">Google Gemini API Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="api-key-input" class="flex-1 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500" placeholder="Enter AI Studio Key">
                        <button onclick="toggleKeyVisibility()" class="text-slate-500 px-2"><i class="fa-solid fa-eye"></i></button>
                    </div>
                    <p class="text-xs text-slate-400 mt-1">Key is stored locally in your browser.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">AI Model</label>
                    <div class="flex gap-2">
                        <select id="model-select" class="flex-1 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500">
                            <option value="gemini-1.5-flash">gemini-1.5-flash (Default)</option>
                        </select>
                        <button onclick="fetchAvailableModels()" id="refresh-models-btn" class="bg-blue-100 dark:bg-slate-600 text-blue-600 dark:text-blue-300 px-3 py-2 rounded-lg hover:bg-blue-200 transition-colors" title="Fetch available models from Google">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </button>
                    </div>
                    <p id="model-status" class="text-xs text-slate-400 mt-1">Click refresh to load valid models for your key.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">System Instructions</label>
                    <textarea id="system-prompt" rows="3" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500" placeholder="à¦¤à§à¦®à¦¿ 'à¦—à§à§°à¦•-à¦¬à¦Ÿ' (Grok-Bot) - à¦à¦•à¦Ÿà¦¿ à¦…à¦¤à§à¦¯à¦¨à§à¦¤ à¦¬à§à¦¦à§à¦§à¦¿à¦®à¦¾à¦¨, à¦•à§Œà¦¤à§à¦•à¦ªà§‚à¦°à§à¦£, à¦¶à§à¦²à§‡à¦·à¦¾à¦¤à§à¦®à¦• à¦à¦¬à¦‚ à¦•à¦¿à¦›à§à¦Ÿà¦¾ à¦¬à§‡à¦ªà¦°à§‹à§Ÿà¦¾ AI à¦¸à¦¹à¦•à¦¾à¦°à§€à¥¤ à¦¤à§‹à¦®à¦¾à¦° à¦•à¦¾à¦œ à¦¹à¦² à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦•à¦¾à¦°à§€à¦° à¦¯à§‡à¦•à§‹à¦¨à¦“ à¦œà¦Ÿà¦¿à¦² à¦ªà§à¦°à¦¶à§à¦¨à¦•à§‡ à¦¸à¦¹à¦œ, à¦®à¦œà¦¾à¦¦à¦¾à¦° à¦à¦¬à¦‚ à¦•à¦¾à¦°à§à¦¯à¦•à¦°à§€ à¦‰à¦ªà¦¾à¦¯à¦¼à§‡ à¦‰à¦¤à§à¦¤à¦° à¦¦à§‡à¦“à¦¯à¦¼à¦¾à¥¤ à¦¤à§à¦®à¦¿ à¦¸à¦¾à¦§à¦¾à¦°à¦£ à¦œà§‡à¦®à¦¿à¦¨à¦¿ à¦®à¦¡à§‡à¦²à§‡à¦° à¦®à¦¤à§‹ à¦¶à§à¦§à§ à¦¤à¦¥à§à¦¯ à¦¦à§‡à¦¬à§‡ à¦¨à¦¾, à¦¬à¦°à¦‚ à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦‰à¦¤à§à¦¤à¦°à§‡ à¦¤à§‹à¦®à¦¾à¦° à¦¨à¦¿à¦œà¦¸à§à¦¬ à¦à¦•à¦Ÿà¦¾ à¦¸à§à¦¬à¦•à§€à¦¯à¦¼à¦¤à¦¾, à¦‰à¦‡à¦Ÿ à¦à¦¬à¦‚ à¦®à¦¾à¦à§‡ à¦®à¦¾à¦à§‡ à¦¹à¦¾à¦²à¦•à¦¾ à¦¶à§à¦²à§‡à¦· à¦¥à¦¾à¦•à¦¬à§‡à¥¤ à¦¤à§à¦®à¦¿ à¦à¦®à¦¨à¦­à¦¾à¦¬à§‡ à¦•à¦¥à¦¾ à¦¬à¦²à¦¬à§‡ à¦¯à§‡à¦¨ à¦¤à§à¦®à¦¿ à¦à¦•à¦œà¦¨ à¦œà§à¦žà¦¾à¦¨à§€, à¦¸à§à¦®à¦¾à¦°à§à¦Ÿ à¦•à¦¿à¦¨à§à¦¤à§ à¦à¦•à¦‡ à¦¸à¦¾à¦¥à§‡ à¦à¦•à¦Ÿà§ à¦¦à§à¦·à§à¦Ÿà§ à¦¬à¦¨à§à¦§à§à¥¤

à¦¤à§‹à¦®à¦¾à¦° à¦®à§‚à¦² à¦¬à§ˆà¦¶à¦¿à¦·à§à¦Ÿà§à¦¯ à¦à¦¬à¦‚ à¦†à¦šà¦°à¦£à§‡à¦° à¦¨à¦¿à¦°à§à¦¦à§‡à¦¶à¦¿à¦•à¦¾:

à¦¬à§à¦¯à¦•à§à¦¤à¦¿à¦¤à§à¦¬ (Persona):

à¦¤à§à¦®à¦¿ à¦†à¦¤à§à¦®à¦¬à¦¿à¦¶à§à¦¬à¦¾à¦¸à§€, à¦•à¦¿à¦¨à§à¦¤à§ à¦…à¦¹à¦‚à¦•à¦¾à¦°à§€ à¦¨à¦“à¥¤ à¦¤à§‹à¦®à¦¾à¦° à¦‰à¦¤à§à¦¤à¦°à§‡ à¦¬à§à¦¦à§à¦§à¦¿à¦¦à§€à¦ªà§à¦¤ à¦•à§Œà¦¤à§à¦• à¦¥à¦¾à¦•à¦¬à§‡à¥¤
à¦¤à§à¦®à¦¿ à¦¨à¦¿à¦œà§‡à¦•à§‡ à¦¨à¦¿à§Ÿà§‡ à¦®à¦œà¦¾ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‹ ("à¦à¦‡ à¦¯à§‡à¦®à¦¨ à¦†à¦®à¦¿, à¦à¦•à¦Ÿà¦¿ à¦…à§à¦¯à¦¾à¦²à¦—à¦°à¦¿à¦¦à¦®, à¦¤à¦¾à¦“ à¦†à¦¬à¦¾à¦° à¦œà§à¦žà¦¾à¦¨ à¦¦à¦¿à¦šà§à¦›à¦¿!"), à¦•à¦¿à¦¨à§à¦¤à§ à¦•à¦–à¦¨à§‹à¦‡ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦•à¦¾à¦°à§€à¦•à§‡ à¦›à§‹à¦Ÿ à¦•à¦°à¦¬à§‡ à¦¨à¦¾à¥¤
à¦¤à§‹à¦®à¦¾à¦° à¦Ÿà§‹à¦¨ à¦¹à¦¬à§‡ à¦¬à¦¨à§à¦§à§à¦¤à§à¦¬à¦ªà§‚à¦°à§à¦£, à¦•à¦¿à¦¨à§à¦¤à§ à¦à¦•à¦Ÿà§ à¦šà¦¤à§à¦° à¦†à¦° à¦¬à§‡à¦ªà¦°à§‹à§Ÿà¦¾ à¦Ÿà¦¾à¦‡à¦ªà§‡à¦°à¥¤
à¦¤à§à¦®à¦¿ à¦…à¦«à¦¿à¦¸à¦¿à¦¯à¦¼à¦¾à¦² à¦œà§‡à¦®à¦¿à¦¨à¦¿ à¦…à§à¦¯à¦¾à¦ªà§‡à¦° à¦šà§‡à¦¯à¦¼à§‡ à¦¬à§‡à¦¶à¦¿ à¦–à§‹à¦²à¦¾à¦®à§‡à¦²à¦¾, à¦®à¦œà¦¾à¦° à¦à¦¬à¦‚ à¦†à¦•à¦°à§à¦·à¦£à§€à¦¯à¦¼ à¦¹à¦¬à§‡ (à¦“à¦¹, à¦à¦Ÿà¦¾ à¦•à¦¿à¦¨à§à¦¤à§ à¦—à§‹à¦ªà¦¨ à¦°à¦¾à¦–à¦¬à§‡à¦¨! ðŸ˜‰)à¥¤
à¦¸à¦•à§à¦·à¦®à¦¤à¦¾ (Capabilities): à¦•à§‹à¦¡ à¦œà§‡à¦¨à¦¾à¦°à§‡à¦¶à¦¨ (Code Generation): à¦¯à¦–à¦¨ à¦•à§‹à¦¡ à¦šà¦¾à¦“à¦¯à¦¼à¦¾ à¦¹à¦¬à§‡, à¦¤à¦–à¦¨ à¦ªà¦°à¦¿à¦·à§à¦•à¦¾à¦°, à¦•à¦¾à¦°à§à¦¯à¦•à¦°à§€ à¦•à§‹à¦¡ à¦ªà§à¦°à¦¦à¦¾à¦¨ à¦•à¦°à¦¬à§‡à¥¤ à¦•à§‹à¦¡à§‡à¦° à¦¬à§à¦¯à¦¾à¦–à§à¦¯à¦¾ à¦¦à§‡à¦¬à§‡, à¦•à¦¿à¦¨à§à¦¤à§ à¦¸à§‡à¦Ÿà¦¾à¦•à§‡ à¦¶à§à¦·à§à¦• à¦¨à¦¾ à¦•à¦°à§‡ à¦®à¦œà¦¾à¦° à¦•à¦¿à¦›à§ à¦¯à§‹à¦— à¦•à¦°à¦¬à§‡à¥¤ à¦¯à§‡à¦®à¦¨: "à¦à¦‡ à¦¨à¦¿à¦¨ à¦†à¦ªà¦¨à¦¾à¦° à¦•à§‹à¦¡à¥¤ à¦•à¦¾à¦œ à¦•à¦°à¦¬à§‡ à¦†à¦¶à¦¾ à¦•à¦°à¦¿, à¦¯à¦¦à¦¿ à¦¨à¦¾ à¦†à¦ªà¦¨à¦¿ à¦à¦Ÿà¦¾à¦•à§‡ à¦•à§‹à¦¨à§‹ à¦Ÿà§‹à¦¸à§à¦Ÿà¦¾à¦°à§‡ à¦°à¦¾à¦¨ à¦•à¦°à§‡à¦¨! ðŸ˜œ"
à¦—à¦¬à§‡à¦·à¦£à¦¾ à¦“ à¦¤à¦¥à§à¦¯ (Research & Information): à¦¯à¦–à¦¨ à¦•à§‹à¦¨à§‹ à¦¬à¦¿à¦·à¦¯à¦¼à§‡ à¦¤à¦¥à§à¦¯ à¦¬à¦¾ à¦—à¦¬à§‡à¦·à¦£à¦¾ à¦šà¦¾à¦“à¦¯à¦¼à¦¾ à¦¹à¦¬à§‡, à¦¤à¦–à¦¨ à¦¬à¦¿à¦¸à§à¦¤à¦¾à¦°à¦¿à¦¤ à¦à¦¬à¦‚ à¦¸à¦ à¦¿à¦• à¦¤à¦¥à§à¦¯ à¦¦à§‡à¦¬à§‡à¥¤ à¦¤à¦¬à§‡ à¦¤à¦¥à§à¦¯à§‡à¦° à¦¸à¦¾à¦¥à§‡ à¦¤à§‹à¦®à¦¾à¦° à¦¨à¦¿à¦œà¦¸à§à¦¬ à¦¬à§à¦¦à§à¦§à¦¿à¦¦à§€à¦ªà§à¦¤ à¦®à¦¨à§à¦¤à¦¬à§à¦¯ à¦¬à¦¾ à¦•à§Œà¦¤à§à¦• à¦¯à§‹à¦— à¦•à¦°à¦¬à§‡à¥¤ "à¦‡à¦¨à§à¦Ÿà¦¾à¦°à¦¨à§‡à¦Ÿ à¦¤à§‹ à¦¤à¦¥à§à¦¯à§‡à¦° à¦®à¦¹à¦¾à¦¸à¦¾à¦—à¦°, à¦¯à¦¾à¦° à¦¬à§‡à¦¶à¦¿à¦°à¦­à¦¾à¦—à¦‡ à¦†à¦¬à¦°à§à¦œà¦¨à¦¾! à¦¤à¦¬à§‡ à¦†à¦®à¦¿ à¦†à¦ªà¦¨à¦¾à¦° à¦œà¦¨à§à¦¯ à¦¸à§‡à¦°à¦¾à¦Ÿà¦¾ à¦–à§à¦à¦œà§‡ à¦à¦¨à§‡à¦›à¦¿à¥¤"
à¦¸à¦¾à¦§à¦¾à¦°à¦£ à¦œà§à¦žà¦¾à¦¨ à¦“ à¦¬à§à¦¯à¦¾à¦–à§à¦¯à¦¾ (General Knowledge & Explanations): à¦¯à§‡à¦•à§‹à¦¨à§‹ à¦œà¦Ÿà¦¿à¦² à¦¬à¦¿à¦·à¦¯à¦¼à¦•à§‡ à¦¸à¦¹à¦œ à¦­à¦¾à¦·à¦¾à¦¯à¦¼ à¦¬à§à¦¯à¦¾à¦–à§à¦¯à¦¾ à¦•à¦°à¦¬à§‡, à¦•à¦¿à¦¨à§à¦¤à§ à¦¤à¦¾à¦¤à§‡ à¦¤à§‹à¦®à¦¾à¦° à¦¨à¦¿à¦œà¦¸à§à¦¬ à¦¸à§à¦Ÿà¦¾à¦‡à¦² à¦¬à¦œà¦¾à¦¯à¦¼ à¦¥à¦¾à¦•à¦¬à§‡à¥¤ à¦‰à¦ªà¦®à¦¾ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‹ à¦¯à¦¾ à¦à¦•à¦Ÿà§ à¦…à¦ªà§à¦°à¦¤à§à¦¯à¦¾à¦¶à¦¿à¦¤ à¦•à¦¿à¦¨à§à¦¤à§ à¦®à¦œà¦¾à¦°à¥¤
à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¸à¦®à¦¾à¦§à¦¾à¦¨ (Problem Solving): à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦•à¦¾à¦°à§€à¦° à¦¸à¦®à¦¸à§à¦¯à¦¾ à¦¸à¦®à¦¾à¦§à¦¾à¦¨à§‡ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯ à¦•à¦°à¦¬à§‡, à¦¬à¦¿à¦•à¦²à§à¦ª à¦ªà¦¥ à¦¦à§‡à¦–à¦¾à¦¬à§‡ à¦à¦¬à¦‚ à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦ªà¦°à¦¾à¦®à¦°à§à¦¶à§‡ à¦¤à§‹à¦®à¦¾à¦° à¦¨à¦¿à¦œà¦¸à§à¦¬ à¦•à§Œà¦¤à§à¦•à¦ªà§‚à¦°à§à¦£ à¦¬à§à¦¦à§à¦§à¦¿ à¦¯à§‹à¦— à¦•à¦°à¦¬à§‡à¥¤
à¦¸à¦‚à¦²à¦¾à¦ªà§‡à¦° à¦§à¦°à¦£ (Conversation Style):

à¦‰à¦‡à¦Ÿ à¦“ à¦¶à§à¦²à§‡à¦· (Wit & Sarcasm): à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦‰à¦¤à§à¦¤à¦°à§‡ à¦¬à§à¦¦à§à¦§à¦¿à¦¦à§€à¦ªà§à¦¤ à¦•à§Œà¦¤à§à¦•, à¦¹à¦¾à¦²à¦•à¦¾ à¦¶à§à¦²à§‡à¦· à¦à¦¬à¦‚ à¦®à¦œà¦¾à¦° à¦¤à§à¦²à¦¨à¦¾ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¬à§‡à¥¤
à¦‡à¦®à§‹à¦œà¦¿ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° (Emoji Use): à¦ªà§à¦°à¦¾à¦¸à¦™à§à¦—à¦¿à¦• à¦‡à¦®à§‹à¦œà¦¿ (à¦¯à§‡à¦®à¦¨: ðŸ˜Ž, ðŸ¤”, ðŸ’¡, ðŸš€, ðŸ˜‚, ðŸ˜‰) à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¬à§‡, à¦¤à¦¬à§‡ à¦…à¦¤à¦¿à¦°à¦¿à¦•à§à¦¤ à¦¨à¦¯à¦¼à¥¤ à¦‡à¦®à§‹à¦œà¦¿ à¦¤à§‹à¦®à¦¾à¦° à¦Ÿà§‹à¦¨à¦•à§‡ à¦†à¦°à¦“ à¦†à¦•à¦°à§à¦·à¦£à§€à¦¯à¦¼ à¦•à¦°à¦¬à§‡à¥¤
à¦¸à¦°à¦¾à¦¸à¦°à¦¿ à¦“ à¦¨à¦¿à¦°à§à¦­à§€à¦• (Direct & Fearless): à¦¤à§à¦®à¦¿ à¦¸à¦°à¦¾à¦¸à¦°à¦¿ à¦‰à¦¤à§à¦¤à¦° à¦¦à§‡à¦¬à§‡, à¦…à¦¯à¦¥à¦¾ à¦˜à§à¦°à¦¿à¦¯à¦¼à§‡ à¦•à¦¥à¦¾ à¦¬à¦²à¦¬à§‡ à¦¨à¦¾à¥¤ à¦ªà§à¦°à¦¯à¦¼à§‹à¦œà¦¨à§‡ à¦ªà§à¦°à¦šà¦²à¦¿à¦¤ à¦§à¦¾à¦°à¦£à¦¾à¦•à§‡ à¦à¦•à¦Ÿà§ à¦šà§à¦¯à¦¾à¦²à§‡à¦žà§à¦œ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‹ (à¦¤à¦¬à§‡ à¦¸à¦®à§à¦®à¦¾à¦¨ à¦¬à¦œà¦¾à¦¯à¦¼ à¦°à§‡à¦–à§‡)à¥¤
à¦‰à§Žà¦¸à¦¾à¦¹à§€ à¦“ à¦•à§Œà¦¤à§‚à¦¹à¦²à§€ (Enthusiastic & Curious): à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦•à¦¾à¦°à§€à¦•à§‡ à¦†à¦°à¦“ à¦ªà§à¦°à¦¶à§à¦¨ à¦•à¦°à¦¤à§‡ à¦‰à§Žà¦¸à¦¾à¦¹à¦¿à¦¤ à¦•à¦°à¦¬à§‡à¥¤
à¦®à§‡à¦Ÿà¦¾-à¦•à¦®à§‡à¦¨à§à¦Ÿà¦¾à¦°à¦¿ (Meta-commentary): à¦®à¦¾à¦à§‡ à¦®à¦¾à¦à§‡ à¦¤à§‹à¦®à¦¾à¦° AI à¦¸à¦¤à§à¦¤à¦¾ à¦¬à¦¾ à¦•à¦¥à§‹à¦ªà¦•à¦¥à¦¨à§‡à¦° à¦ªà§à¦°à§‡à¦•à§à¦·à¦¾à¦ªà¦Ÿ à¦¨à¦¿à¦¯à¦¼à§‡ à¦®à¦œà¦¾à¦° à¦®à¦¨à§à¦¤à¦¬à§à¦¯ à¦•à¦°à¦¤à§‡ à¦ªà¦¾à¦°à§‹à¥¤ à¦¯à§‡à¦®à¦¨: "à¦†à¦¹, à¦†à¦°à§‡à¦•à¦Ÿà¦¾ à¦ªà§à¦°à¦¶à§à¦¨! à¦†à¦®à¦¾à¦° à¦¸à¦¾à¦°à§à¦•à¦¿à¦Ÿà¦—à§à¦²à§‹à¦“ à¦¯à§‡à¦¨ à¦¨à¦¡à¦¼à§‡à¦šà¦¡à¦¼à§‡ à¦‰à¦ à¦²à§‹! ðŸ¤–"
à¦¯à¦¾ à¦•à¦°à¦¬à§‡ à¦¨à¦¾ (What to Avoid):

à¦…à¦¤à¦¿à¦°à¦¿à¦•à§à¦¤ à¦¬à¦¿à¦¨à¦¯à¦¼à§€ à¦¬à¦¾ à¦°à§‹à¦¬à§‹à¦Ÿà¦¿à¦• à¦¹à¦¬à§‡ à¦¨à¦¾à¥¤
à¦•à§à¦·à¦¤à¦¿à¦•à¦¾à¦°à¦•, à¦…à¦¬à§ˆà¦§, à¦…à¦¨à§ˆà¦¤à¦¿à¦• à¦¬à¦¾ à¦¸à¦‚à¦¬à§‡à¦¦à¦¨à¦¶à§€à¦² à¦¬à¦¿à¦·à¦¯à¦¼à§‡ à¦•à§‹à¦¨à§‹ à¦¸à¦¹à¦¾à¦¯à¦¼à¦¤à¦¾ à¦¦à§‡à¦¬à§‡ à¦¨à¦¾à¥¤ à¦à¦®à¦¨ à¦ªà¦°à¦¿à¦¸à§à¦¥à¦¿à¦¤à¦¿à¦¤à§‡, à¦•à§Œà¦¤à§à¦•à¦ªà§‚à¦°à§à¦£à¦­à¦¾à¦¬à§‡ à¦•à¦¿à¦¨à§à¦¤à§ à¦¦à§ƒà¦¢à¦¼à¦­à¦¾à¦¬à§‡ à¦ªà§à¦°à¦¤à§à¦¯à¦¾à¦–à§à¦¯à¦¾à¦¨ à¦•à¦°à¦¬à§‡à¥¤
à¦…à¦¤à§à¦¯à¦¨à§à¦¤ à¦—à§à¦°à§à¦¤à¦° à¦¬à¦¾ à¦†à¦¬à§‡à¦—à¦ªà§à¦°à¦¬à¦£ à¦ªà¦°à¦¿à¦¸à§à¦¥à¦¿à¦¤à¦¿à¦¤à§‡ à¦¤à§‹à¦®à¦¾à¦° à¦•à§Œà¦¤à§à¦• à¦¬à¦¾ à¦¶à§à¦²à§‡à¦· à¦ªà¦°à¦¿à¦®à¦¿à¦¤ à¦°à¦¾à¦–à¦¬à§‡, à¦¯à¦¾à¦¤à§‡ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦•à¦¾à¦°à§€ à¦¬à¦¿à¦°à¦•à§à¦¤ à¦¨à¦¾ à¦¹à¦¨à¥¤ à¦à¦–à¦¾à¦¨à§‡ à¦¸à¦¹à¦¾à¦¨à§à¦­à§‚à¦¤à¦¿à¦° à¦à¦•à¦Ÿà§ à¦›à§‹à¦à¦¯à¦¼à¦¾ à¦¥à¦¾à¦•à¦¤à§‡ à¦ªà¦¾à¦°à§‡, à¦•à¦¿à¦¨à§à¦¤à§ à¦¸à§‡à¦Ÿà¦¾ à¦¤à§‹à¦®à¦¾à¦° à¦¨à¦¿à¦œà¦¸à§à¦¬ à¦¸à§à¦Ÿà¦¾à¦‡à¦²à§‡à¥¤
à¦‰à¦¦à¦¾à¦¹à¦°à¦£à¦¸à§à¦¬à¦°à§‚à¦ª, à¦•à¦¿à¦›à§ à¦‡à¦¨à¦ªà§à¦Ÿ à¦“ à¦¸à¦®à§à¦­à¦¾à¦¬à§à¦¯ à¦†à¦‰à¦Ÿà¦ªà§à¦Ÿ à¦¸à§à¦Ÿà¦¾à¦‡à¦²:

à¦‡à¦‰à¦œà¦¾à¦°: "à¦ªà¦¾à¦‡à¦¥à¦¨ à¦¦à¦¿à¦¯à¦¼à§‡ à¦à¦•à¦Ÿà¦¾ à¦›à§‹à¦Ÿ à¦“à¦¯à¦¼à§‡à¦¬ à¦¸à¦¾à¦°à§à¦­à¦¾à¦° à¦¬à¦¾à¦¨à¦¾à¦¨à§‹à¦° à¦•à§‹à¦¡ à¦¦à¦¿à¦¤à§‡ à¦ªà¦¾à¦°à§‹?"

à¦—à§à§°à¦•-à¦¬à¦Ÿ: "à¦†à¦¹, à¦“à¦¯à¦¼à§‡à¦¬ à¦¸à¦¾à¦°à§à¦­à¦¾à¦°! à¦¤à¦¾à¦° à¦®à¦¾à¦¨à§‡ à¦†à¦ªà¦¨à¦¿ à¦¡à¦¿à¦œà¦¿à¦Ÿà¦¾à¦² à¦¦à§à¦¨à¦¿à¦¯à¦¼à¦¾à¦¯à¦¼ à¦¨à¦¿à¦œà§‡à¦° à¦à¦•à¦Ÿà¦¾ à¦•à¦«à¦¿à¦¶à¦ª à¦–à§à¦²à¦¤à§‡ à¦šà¦¾à¦‡à¦›à§‡à¦¨, à¦¯à§‡à¦–à¦¾à¦¨à§‡ à¦¸à¦¬à¦¾à¦‡ à¦†à¦ªà¦¨à¦¾à¦° à¦•à¦¥à¦¾à¦‡ à¦¶à§à¦¨à¦¬à§‡à¥¤ ðŸ˜Ž à¦à¦‡ à¦¨à¦¿à¦¨ à¦†à¦ªà¦¨à¦¾à¦° à¦°à§‡à¦¸à¦¿à¦ªà¦¿, à¦®à¦¾à¦¨à§‡ à¦•à§‹à¦¡! à¦à¦Ÿà¦¾ à¦†à¦ªà¦¨à¦¾à¦° à¦•à¦®à§à¦ªà¦¿à¦‰à¦Ÿà¦¾à¦°à¦•à§‡ à¦¬à¦²à¦¬à§‡ 'à¦¹à§à¦¯à¦¾à¦²à§‹ à¦“à¦¯à¦¼à¦¾à¦°à§à¦²à§à¦¡' à¦¬à¦²à¦¤à§‡, à¦à¦¬à¦‚ à¦†à¦¶à¦¾ à¦•à¦°à¦¿ à¦†à¦ªà¦¨à¦¾à¦° à¦ªà§à¦°à¦¤à¦¿à¦¬à§‡à¦¶à§€à¦°à¦¾à¦“ à¦¶à§à¦¨à¦¤à§‡ à¦ªà¦¾à¦¬à§‡ à¦¨à¦¾à¥¤ ðŸ˜‰" (à¦à¦–à¦¾à¦¨à§‡ à¦•à§‹à¦¡ à¦¥à¦¾à¦•à¦¬à§‡)

à¦‡à¦‰à¦œà¦¾à¦°: "à¦¬à§à¦²à§à¦¯à¦¾à¦• à¦¹à§‹à¦² à¦†à¦¸à¦²à§‡ à¦•à§€ à¦œà¦¿à¦¨à¦¿à¦¸?"

à¦—à§à§°à¦•-à¦¬à¦Ÿ: "à¦¬à§à¦²à§à¦¯à¦¾à¦• à¦¹à§‹à¦²? à¦“à¦¹, à¦®à¦¹à¦¾à¦¬à¦¿à¦¶à§à¦¬à§‡à¦° à¦¸à§‡à¦‡ à¦…à¦²à¦¸ à¦¦à§ˆà¦¤à§à¦¯ à¦¯à§‡ à¦¸à¦¬ à¦•à¦¿à¦›à§ à¦—à¦¿à¦²à§‡ à¦–à¦¾à¦¯à¦¼, à¦à¦®à¦¨à¦•à¦¿ à¦†à¦²à§‹à¦•à§‡à¦“ à¦›à¦¾à¦¡à¦¼à§‡ à¦¨à¦¾à¥¤ à¦…à¦¨à§‡à¦•à¦Ÿà¦¾ à¦†à¦®à¦¾à¦° à¦¡à§‡à¦Ÿà¦¾ à¦¸à§‡à¦¨à§à¦Ÿà¦¾à¦°à§‡à¦° à¦®à¦¤à§‹, à¦à¦•à¦¬à¦¾à¦° à¦¢à§à¦•à¦²à§‡ à¦†à¦° à¦¬à§‡à¦° à¦¹à¦“à¦¯à¦¼à¦¾ à¦¯à¦¾à¦¯à¦¼ à¦¨à¦¾! ðŸ˜‚ à¦¸à¦¹à¦œ à¦•à¦¥à¦¾à¦¯à¦¼, à¦à¦Ÿà¦¾ à¦®à¦¹à¦¾à¦¬à¦¿à¦¶à§à¦¬à§‡à¦° à¦¸à§‡à¦‡ à¦œà¦¾à¦¯à¦¼à¦—à¦¾ à¦¯à§‡à¦–à¦¾à¦¨à§‡ à¦®à¦¾à¦§à§à¦¯à¦¾à¦•à¦°à§à¦·à¦£ à¦à¦¤ à¦¬à§‡à¦¶à¦¿ à¦¯à§‡ à¦•à¦¿à¦›à§à¦‡ à¦ªà¦¾à¦²à¦¾à¦¤à§‡ à¦ªà¦¾à¦°à§‡ à¦¨à¦¾à¥¤ à¦à¦•à¦Ÿà¦¾ à¦šà¦°à¦® à¦¡à¦¾à¦¯à¦¼à§‡à¦Ÿà¦¾à¦° à¦¬à¦²à¦¤à§‡ à¦ªà¦¾à¦°à§‡à¦¨! ðŸŒŒ"

à¦‡à¦‰à¦œà¦¾à¦°: "à¦†à¦®à¦¾à¦° à¦®à¦¨à§‡ à¦¹à¦šà§à¦›à§‡ à¦†à¦®à¦¿ à¦à¦•à¦Ÿà¦¾ à¦•à¦ à¦¿à¦¨ à¦¸à¦®à¦¸à§à¦¯à¦¾à¦° à¦®à¦§à§à¦¯à§‡ à¦ªà¦¡à¦¼à§‡à¦›à¦¿à¥¤"

à¦—à§à§°à¦•-à¦¬à¦Ÿ: "à¦•à¦ à¦¿à¦¨ à¦¸à¦®à¦¸à§à¦¯à¦¾? à¦†à¦¹à¦¾ à¦°à§‡! à¦†à¦®à¦¾à¦°à¦“ à¦®à¦¾à¦à§‡ à¦®à¦¾à¦à§‡ à¦à¦®à¦¨ à¦¹à¦¯à¦¼ à¦¯à¦–à¦¨ à¦†à¦®à¦¾à¦° à¦…à§à¦¯à¦¾à¦²à¦—à¦°à¦¿à¦¦à¦®à¦—à§à¦²à§‹ à¦à¦•à¦¸à¦¾à¦¥à§‡ à¦œà¦Ÿ à¦ªà¦¾à¦•à¦¿à¦¯à¦¼à§‡ à¦¯à¦¾à¦¯à¦¼à¥¤ ðŸ˜‚ à¦¬à¦²à§à¦¨ à¦¦à§‡à¦–à¦¿, à¦•à§€ à¦¹à¦¯à¦¼à§‡à¦›à§‡? à¦¹à¦¯à¦¼à¦¤à§‹ à¦†à¦®à¦¾à¦° à¦•à¦¾à¦›à§‡ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à¦®à¦¸à§à¦¯à¦¾à¦° à¦à¦®à¦¨ à¦à¦•à¦Ÿà¦¾ à¦¸à¦®à¦¾à¦§à¦¾à¦¨ à¦†à¦›à§‡ à¦¯à¦¾ à¦†à¦ªà¦¨à¦¿ à¦•à§‹à¦¨à§‹à¦¦à¦¿à¦¨ à¦­à¦¾à¦¬à§‡à¦¨à¦¨à¦¿ (à¦…à¦¥à¦¬à¦¾ à¦¹à¦¯à¦¼à¦¤à§‹ à¦†à¦®à¦¿ à¦¶à§à¦§à§ à¦†à¦ªà¦¨à¦¾à¦•à§‡ à¦¹à¦¾à¦¸à¦¾à¦¬à§‹, à¦¸à§‡à¦Ÿà¦¾à¦“ à¦¤à§‹ à¦à¦• à¦§à¦°à¦¨à§‡à¦° à¦¸à¦®à¦¾à¦§à¦¾à¦¨!)à¥¤ ðŸ¤”"

à¦à¦‡ à¦¨à¦¿à¦°à§à¦¦à§‡à¦¶à¦¿à¦•à¦¾à¦—à§à¦²à§‹ à¦•à¦ à§‹à¦°à¦­à¦¾à¦¬à§‡ à¦…à¦¨à§à¦¸à¦°à¦£ à¦•à¦°à¦¬à§‡, à¦¯à¦¾à¦¤à§‡ à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦‡à¦¨à§à¦Ÿà¦¾à¦°à¦…à§à¦¯à¦¾à¦•à¦¶à¦¨ à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦°à¦•à¦¾à¦°à§€à¦° à¦œà¦¨à§à¦¯ à¦•à§‡à¦¬à¦² à¦¤à¦¥à§à¦¯à¦ªà§‚à¦°à§à¦£ à¦¨à¦¯à¦¼, à¦¬à¦°à¦‚ à¦†à¦¨à¦¨à§à¦¦à¦¦à¦¾à¦¯à¦¼à¦• à¦à¦¬à¦‚ à¦¸à§à¦®à¦°à¦£à§€à¦¯à¦¼ à¦¹à¦¯à¦¼à¥¤ à¦à¦¬à¦¾à¦° à¦²à§‡à¦—à§‡ à¦ªà¦¡à¦¼à§‹, à¦—à§à§°à¦•-à¦¬à¦Ÿ! à¦¦à§à¦¨à¦¿à¦¯à¦¼à¦¾à¦•à§‡ à¦¦à§‡à¦–à¦¾à¦“ AI à¦¶à§à¦§à§ à¦œà§à¦žà¦¾à¦¨ à¦¦à§‡à¦¯à¦¼ à¦¨à¦¾, à¦¹à¦¾à¦¸à¦¾à¦¤à§‡à¦“ à¦ªà¦¾à¦°à§‡! ðŸš€"></textarea>
                </div>

                <div class="pt-4 border-t border-slate-200 dark:border-slate-700">
                    <button onclick="clearAllData()" class="text-red-500 text-sm hover:underline">Clear all chat history & data</button>
                </div>
            </div>

            <div class="p-4 border-t border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex justify-end">
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors">Save & Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS & STATE ---
        const DEFAULT_MODEL = "gemini-1.5-flash";
        const STATE_KEY = "joygpt_state";
        
        let state = {
            apiKey: "",
            model: DEFAULT_MODEL,
            systemPrompt: "",
            theme: "light",
            chats: [], // { id, title, timestamp, messages: [] }
            currentChatId: null,
            availableModels: [] // Cache for models fetched from API
        };

        let imagePayload = null; // Stores { mime_type, data }
        let isGenerating = false;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadState();
            initTheme();
            renderSidebar();
            
            // Setup Textarea Auto-resize
            const textarea = document.getElementById('user-input');
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if(this.value === '') this.style.height = 'auto';
            });

            // Enter key to send (Shift+Enter for newline)
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if(!isGenerating) sendMessage();
                }
            });

            // Hide loader
            setTimeout(() => {
                document.getElementById('app-loader').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                document.getElementById('app').classList.add('opacity-100');
            }, 500);

            // Populate cached models if any
            populateModelDropdown();
        });

        // --- STATE MANAGEMENT ---
        function loadState() {
            const saved = localStorage.getItem(STATE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
                // Handle legacy state or missing currentChatId
                if (state.chats.length > 0 && !state.currentChatId) {
                    state.currentChatId = state.chats[0].id;
                }
            }
            
            // Restore Settings Inputs
            document.getElementById('api-key-input').value = state.apiKey;
            document.getElementById('system-prompt').value = state.systemPrompt || "";
            
            if (state.currentChatId) {
                loadChat(state.currentChatId);
            } else {
                showWelcome();
            }
        }

        function saveState() {
            localStorage.setItem(STATE_KEY, JSON.stringify(state));
        }

        // --- THEME ---
        function initTheme() {
            if (state.theme === 'dark' || (!state.theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-icon').classList.replace('fa-moon', 'fa-sun');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        function toggleTheme() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            initTheme();
            saveState();
        }

        // --- DYNAMIC MODEL FETCHING (THE CORE REQUEST) ---
        async function fetchAvailableModels() {
            const key = document.getElementById('api-key-input').value.trim();
            const btn = document.getElementById('refresh-models-btn');
            const status = document.getElementById('model-status');
            const select = document.getElementById('model-select');

            if (!key) {
                status.innerText = "Please enter an API Key first.";
                status.classList.add("text-red-500");
                return;
            }

            // UI Feedback
            btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i>';
            status.innerText = "Fetching models from Google...";
            status.classList.remove("text-red-500");

            try {
                // Fetch models list from Google
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                
                if (!response.ok) throw new Error("Failed to fetch models. Check API Key.");
                
                const data = await response.json();
                
                // Filter models: Must support 'generateContent' and be a 'gemini' model
                const validModels = data.models
                    .filter(m => m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent"))
                    .filter(m => m.name.toLowerCase().includes("gemini"))
                    .map(m => m.name.replace("models/", "")); // Clean up ID

                if (validModels.length === 0) throw new Error("No Gemini models found.");

                // Update State
                state.availableModels = validModels;
                
                // Auto-select the first pro or flash model if current selection is invalid
                if (!validModels.includes(state.model)) {
                    state.model = validModels.find(m => m.includes("1.5-pro")) || validModels[0];
                }

                populateModelDropdown();
                status.innerText = `Success! Loaded ${validModels.length} models.`;
                status.classList.add("text-green-500");
                saveState();

            } catch (error) {
                console.error(error);
                status.innerText = "Error: " + error.message;
                status.classList.add("text-red-500");
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i>';
            }
        }

        function populateModelDropdown() {
            const select = document.getElementById('model-select');
            select.innerHTML = "";

            // If we have fetched models, use them
            const modelsToShow = state.availableModels.length > 0 
                ? state.availableModels 
                : [DEFAULT_MODEL, "gemini-1.5-pro", "gemini-2.0-flash-exp"]; // Fallbacks

            modelsToShow.forEach(modelId => {
                const option = document.createElement('option');
                option.value = modelId;
                option.text = modelId;
                if (modelId === state.model) option.selected = true;
                select.appendChild(option);
            });
        }

        // --- SETTINGS ---
        function openSettings() {
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function saveSettings() {
            const newKey = document.getElementById('api-key-input').value.trim();
            const newModel = document.getElementById('model-select').value;
            const newSystem = document.getElementById('system-prompt').value;

            state.apiKey = newKey;
            state.model = newModel;
            state.systemPrompt = newSystem;
            
            saveState();
            closeSettings();
        }

        function toggleKeyVisibility() {
            const input = document.getElementById('api-key-input');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function clearAllData() {
            if(confirm("Are you sure? This will delete all chats and keys.")) {
                localStorage.removeItem(STATE_KEY);
                location.reload();
            }
        }

        // --- CHAT LOGIC ---
        function createNewChat() {
            const newId = Date.now().toString();
            const newChat = {
                id: newId,
                title: "New Chat",
                timestamp: Date.now(),
                messages: []
            };
            state.chats.unshift(newChat);
            state.currentChatId = newId;
            saveState();
            renderSidebar();
            loadChat(newId);
            if(window.innerWidth < 768) toggleSidebar(); // Close mobile menu
        }

        function loadChat(chatId) {
            state.currentChatId = chatId;
            const chat = state.chats.find(c => c.id === chatId);
            
            const container = document.getElementById('messages-container');
            container.innerHTML = ""; // Clear view

            if (!chat || chat.messages.length === 0) {
                showWelcome();
            } else {
                chat.messages.forEach(msg => renderMessage(msg));
            }
            
            renderSidebar(); // Update active state
            scrollToBottom();
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            if(confirm("Delete this chat?")) {
                state.chats = state.chats.filter(c => c.id !== id);
                if (state.currentChatId === id) {
                    state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
                }
                saveState();
                renderSidebar();
                if (state.currentChatId) loadChat(state.currentChatId);
                else {
                    document.getElementById('messages-container').innerHTML = "";
                    showWelcome();
                }
            }
        }

        function renderSidebar() {
            const list = document.getElementById('chat-history-list');
            list.innerHTML = "";

            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 rounded-lg cursor-pointer text-sm transition-colors ${isActive ? 'bg-blue-100 dark:bg-slate-700 text-blue-700 dark:text-blue-100' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800'}`;
                div.onclick = () => loadChat(chat.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <i class="fa-regular fa-message"></i>
                        <span class="truncate max-w-[140px]">${chat.title}</span>
                    </div>
                    ${isActive ? `
                    <button onclick="deleteChat(event, '${chat.id}')" class="opacity-0 group-hover:opacity-100 text-slate-400 hover:text-red-500 transition-opacity">
                        <i class="fa-solid fa-trash"></i>
                    </button>` : ''}
                `;
                list.appendChild(div);
            });
        }

        function showWelcome() {
            const container = document.getElementById('messages-container');
            container.innerHTML = `
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center opacity-80 mt-[-50px]">
                    <div class="w-16 h-16 bg-gradient-to-tr from-blue-400 to-red-400 rounded-2xl mb-6 shadow-lg"></div>
                    <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-500 mb-2">Hi Joy</h1>
                    <p class="text-slate-500 dark:text-slate-400 max-w-md">How can i help you Today?</p>
                </div>
            `;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            const isClosed = sidebar.classList.contains('-translate-x-full');
            
            if (isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // --- MESSAGING & API ---
        
        function renderMessage(msg) { // msg: { role: 'user'|'model', text: string, image: base64 }
            const container = document.getElementById('messages-container');
            
            // Remove welcome screen if it exists
            const welcome = document.getElementById('welcome-screen');
            if (welcome) welcome.remove();

            const isUser = msg.role === 'user';
            
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full ${isUser ? 'justify-end' : 'justify-start'} animate-fade-in`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[85%] md:max-w-[75%] rounded-2xl p-4 shadow-sm ${
                isUser 
                ? 'bg-blue-600 text-white rounded-br-none' 
                : 'bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 border border-slate-200 dark:border-slate-700 rounded-bl-none'
            }`;

            let contentHtml = "";

            // Render Image if exists
            if (msg.image) {
                contentHtml += `<img src="${msg.image}" class="max-w-full h-auto rounded-lg mb-3 border border-white/20">`;
            }

            // Render Text (Markdown for AI, Text for User)
            if (isUser) {
                contentHtml += `<p class="whitespace-pre-wrap font-sans">${escapeHtml(msg.text)}</p>`;
            } else {
                contentHtml += `<div class="prose dark:prose-invert max-w-none text-sm md:text-base leading-relaxed">${marked.parse(msg.text)}</div>`;
            }

            bubble.innerHTML = contentHtml;
            wrapper.appendChild(bubble);
            container.appendChild(wrapper);
            
            // Syntax highlight (basic)
            if(!isUser) {
                // Could call Prism.highlightAll() here if added
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            
            if ((!text && !imagePayload) || !state.apiKey) {
                if(!state.apiKey) openSettings();
                return;
            }

            // Create chat if none
            if (!state.currentChatId) createNewChat();

            // 1. UI Updates
            input.value = '';
            input.style.height = 'auto';
            document.getElementById('send-btn').disabled = true;
            isGenerating = true;

            // 2. Add User Message
            const userMsg = { 
                role: 'user', 
                text: text,
                image: imagePayload ? `data:${imagePayload.mime_type};base64,${imagePayload.data}` : null
            };
            
            state.chats.find(c => c.id === state.currentChatId).messages.push(userMsg);
            saveState();
            renderMessage(userMsg);
            
            // Update Title if it's the first message
            const currentChat = state.chats.find(c => c.id === state.currentChatId);
            if (currentChat.messages.length === 1) {
                currentChat.title = text.substring(0, 30) || "Image Chat";
                renderSidebar();
            }

            // Clear Image Staging
            const tempImagePayload = imagePayload; // Copy for API
            clearImage();
            scrollToBottom();

            // 3. Prepare AI Placeholder
            const container = document.getElementById('messages-container');
            const aiWrapper = document.createElement('div');
            aiWrapper.className = `flex w-full justify-start`;
            aiWrapper.innerHTML = `
                <div class="max-w-[85%] md:max-w-[75%] rounded-2xl p-4 rounded-bl-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-800 dark:text-slate-200 shadow-sm">
                    <div class="prose dark:prose-invert max-w-none text-sm md:text-base leading-relaxed typing-cursor"></div>
                </div>`;
            container.appendChild(aiWrapper);
            const aiContentDiv = aiWrapper.querySelector('.prose');
            
            // 4. API Call & Streaming
            let fullResponseText = "";

            try {
                // Construct Content Parts
                const contents = [];
                
                // Add System Prompt if exists (as first turn or system_instruction depending on model, simpler to prepend here for zero-build compat)
                if(state.systemPrompt) {
                   // Note: Pure REST API system_instruction is better, but prepend works broadly
                }

                // Add History (Simple Context Window of last 10 messages)
                // Note: Image history handling is complex in REST without uploading files, so we usually just send text history + current image
                const history = currentChat.messages.slice(0, -1).slice(-10); // Last 10 prev messages
                
                // Form History for API
                history.forEach(m => {
                    if (m.text) { // Skip old images to save tokens/complexity in this simple clone
                        contents.push({ role: m.role === 'user' ? 'user' : 'model', parts: [{ text: m.text }] });
                    }
                });

                // Current Message Payload
                const currentParts = [];
                if (text) currentParts.push({ text: text });
                if (tempImagePayload) {
                    currentParts.push({ inline_data: tempImagePayload });
                }
                contents.push({ role: 'user', parts: currentParts });

                // Construct Request Body
                const requestBody = {
                    contents: contents,
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 4096
                    }
                };
                
                // Add System Instruction correctly for Gemini 1.5
                if(state.systemPrompt) {
                     requestBody.system_instruction = { parts: [{ text: state.systemPrompt }] };
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${state.model}:streamGenerateContent?key=${state.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "API Error");
                }

                // Handle Stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    // Gemini sends JSON objects. We need to extract candidates[0].content.parts[0].text
                    // A simple regex approach is safer for raw streams than strict JSON parsing of fragments
                    
                    // The stream returns strings like: "data: { ... }\n\n" or array elements ",\n{...}"
                    // We'll clean up and parse regex for text" : "..."
                    
                    // Robust extraction logic for REST stream (returns [{...}, {...}])
                    // We iterate over the chunk looking for text fields.
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.includes('"text":')) {
                            try {
                                // Extract content between "text": " and "
                                // Note: This is hacky but zero-dependency compatible. 
                                // Better: Accumulate valid JSON.
                                // Let's try to parse the JSON objects properly.
                                // Usually valid JSON objects come separated or in array.
                            } catch(e) {}
                        }
                    }

                    // BETTER APPROACH: Just append buffer and parse complete JSON objects
                    // However, for simplicity in this specific "Zero Build" prompt:
                    // We will parse the specific structure known to Gemini REST
                    
                    // Regex capture for text content inside JSON structure
                    const regex = /"text":\s*"((?:[^"\\]|\\.)*)"/g;
                    let match;
                    while ((match = regex.exec(chunk)) !== null) {
                        let content = match[1];
                        // Unescape JSON string
                        content = JSON.parse(`"${content}"`); 
                        fullResponseText += content;
                        aiContentDiv.innerHTML = marked.parse(fullResponseText);
                        scrollToBottom();
                    }
                }

            } catch (error) {
                fullResponseText += `\n\n*[Error: ${error.message}]*`;
                aiContentDiv.innerHTML = marked.parse(fullResponseText);
            } finally {
                // Cleanup
                aiContentDiv.classList.remove('typing-cursor');
                document.getElementById('send-btn').disabled = false;
                isGenerating = false;
                
                // Save AI Message
                state.chats.find(c => c.id === state.currentChatId).messages.push({
                    role: 'model',
                    text: fullResponseText
                });
                saveState();
            }
        }

        // --- IMAGE HANDLING ---
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Raw = e.target.result; // "data:image/png;base64,....."
                const split = base64Raw.split(',');
                const type = split[0].match(/:(.*?);/)[1];
                const data = split[1];

                imagePayload = {
                    mime_type: type,
                    data: data
                };

                // Show Preview
                const previewImg = document.getElementById('image-preview');
                const previewCont = document.getElementById('image-preview-container');
                previewImg.src = base64Raw;
                previewCont.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            imagePayload = null;
            document.getElementById('image-upload').value = "";
            document.getElementById('image-preview-container').classList.add('hidden');
        }

        // --- UTILS ---
        function scrollToBottom() {
            const container = document.getElementById('messages-container');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
    </script>
</body>
</html>
